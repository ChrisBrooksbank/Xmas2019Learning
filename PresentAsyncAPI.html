<!DOCTYPE html>
<!-- saved from url=(0052)file:///C:/users/brooks~1/appdata/local/temp/13.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><style>@font-face {
  font-family: octicons-anchor;
  src: url(https://cdnjs.cloudflare.com/ajax/libs/octicons/4.4.0/font/octicons.woff) format('woff');
}

* {
    box-sizing: border-box;
}

body {
    width: 980px;
    margin-right: auto;
    margin-left: auto;
    color:#333;
    background:#fff;
}

body .markdown-body {
    padding: 45px;
    border: 1px solid #ddd;
    border-radius: 3px;
    word-wrap: break-word;
}

pre {
    font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}

.markdown-body {
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
  color: #333;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
}

.markdown-body a {
  background-color: transparent;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline: 0;
}

.markdown-body strong {
  font-weight: bold;
}

.markdown-body h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

.markdown-body img {
  border: 0;
}

.markdown-body hr {
  box-sizing: content-box;
  height: 0;
}

.markdown-body pre {
  overflow: auto;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre {
  font-family: monospace, monospace;
  font-size: 1em;
}

.markdown-body input {
  color: inherit;
  font: inherit;
  margin: 0;
}

.markdown-body html input[disabled] {
  cursor: default;
}

.markdown-body input {
  line-height: normal;
}

.markdown-body input[type="checkbox"] {
  box-sizing: border-box;
  padding: 0;
}

.markdown-body table {
  border-collapse: collapse;
  border-spacing: 0;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body input {
  font: 13px / 1.4 Helvetica, arial, nimbussansl, liberationsans, freesans, clean, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
}

.markdown-body a {
  color: #4078c0;
  text-decoration: none;
}

.markdown-body a:hover,
.markdown-body a:active {
  text-decoration: underline;
}

.markdown-body hr {
  height: 0;
  margin: 15px 0;
  overflow: hidden;
  background: transparent;
  border: 0;
  border-bottom: 1px solid #ddd;
}

.markdown-body hr:before {
  display: table;
  content: "";
}

.markdown-body hr:after {
  display: table;
  clear: both;
  content: "";
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 15px;
  margin-bottom: 15px;
  line-height: 1.1;
}

.markdown-body h1 {
  font-size: 30px;
}

.markdown-body h2 {
  font-size: 21px;
}

.markdown-body h3 {
  font-size: 16px;
}

.markdown-body h4 {
  font-size: 14px;
}

.markdown-body h5 {
  font-size: 12px;
}

.markdown-body h6 {
  font-size: 11px;
}

.markdown-body blockquote {
  margin: 0;
}

.markdown-body ul,
.markdown-body ol {
  padding: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code {
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 12px;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
  font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}

.markdown-body .select::-ms-expand {
  opacity: 0;
}

.markdown-body .octicon {
  font: normal normal normal 16px/1 octicons-anchor;
  display: inline-block;
  text-decoration: none;
  text-rendering: auto;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.markdown-body .octicon-link:before {
  content: '\f05c';
}

.markdown-body:before {
  display: table;
  content: "";
}

.markdown-body:after {
  display: table;
  clear: both;
  content: "";
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body a:not([href]) {
  color: inherit;
  text-decoration: none;
}

.markdown-body .anchor {
  display: inline-block;
  padding-right: 2px;
  margin-left: -18px;
}

.markdown-body .anchor:focus {
  outline: none;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 1em;
  margin-bottom: 16px;
  font-weight: bold;
  line-height: 1.4;
}

.markdown-body h1 .octicon-link,
.markdown-body h2 .octicon-link,
.markdown-body h3 .octicon-link,
.markdown-body h4 .octicon-link,
.markdown-body h5 .octicon-link,
.markdown-body h6 .octicon-link {
  color: #000;
  vertical-align: middle;
  visibility: hidden;
}

.markdown-body h1:hover .anchor,
.markdown-body h2:hover .anchor,
.markdown-body h3:hover .anchor,
.markdown-body h4:hover .anchor,
.markdown-body h5:hover .anchor,
.markdown-body h6:hover .anchor {
  text-decoration: none;
}

.markdown-body h1:hover .anchor .octicon-link,
.markdown-body h2:hover .anchor .octicon-link,
.markdown-body h3:hover .anchor .octicon-link,
.markdown-body h4:hover .anchor .octicon-link,
.markdown-body h5:hover .anchor .octicon-link,
.markdown-body h6:hover .anchor .octicon-link {
  visibility: visible;
}

.markdown-body h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid #eee;
}

.markdown-body h1 .anchor {
  line-height: 1;
}

.markdown-body h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}

.markdown-body h2 .anchor {
  line-height: 1;
}

.markdown-body h3 {
  font-size: 1.5em;
  line-height: 1.43;
}

.markdown-body h3 .anchor {
  line-height: 1.2;
}

.markdown-body h4 {
  font-size: 1.25em;
}

.markdown-body h4 .anchor {
  line-height: 1.2;
}

.markdown-body h5 {
  font-size: 1em;
}

.markdown-body h5 .anchor {
  line-height: 1.1;
}

.markdown-body h6 {
  font-size: 1em;
  color: #777;
}

.markdown-body h6 .anchor {
  line-height: 1.1;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: #e7e7e7;
  border: 0 none;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: bold;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body blockquote {
  padding: 0 15px;
  color: #777;
  border-left: 4px solid #ddd;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
  word-break: normal;
  word-break: keep-all;
}

.markdown-body table th {
  font-weight: bold;
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #ddd;
}

.markdown-body table tr {
  background-color: #fff;
  border-top: 1px solid #ccc;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

.markdown-body img {
  max-width: 100%;
  box-sizing: content-box;
  background-color: #fff;
}

.markdown-body code {
  padding: 0;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(0,0,0,0.04);
  border-radius: 3px;
}

.markdown-body code:before,
.markdown-body code:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .highlight {
  margin-bottom: 16px;
}

.markdown-body .highlight pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f7f7f7;
  border-radius: 3px;
}

.markdown-body .highlight pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body pre code:before,
.markdown-body pre code:after {
  content: normal;
}

.markdown-body kbd {
  display: inline-block;
  padding: 3px 5px;
  font-size: 11px;
  line-height: 10px;
  color: #555;
  vertical-align: middle;
  background-color: #fcfcfc;
  border: solid 1px #ccc;
  border-bottom-color: #bbb;
  border-radius: 3px;
  box-shadow: inset 0 -1px 0 #bbb;
}

.markdown-body .pl-c {
  color: #969896;
}

.markdown-body .pl-c1,
.markdown-body .pl-s .pl-v {
  color: #0086b3;
}

.markdown-body .pl-e,
.markdown-body .pl-en {
  color: #795da3;
}

.markdown-body .pl-s .pl-s1,
.markdown-body .pl-smi {
  color: #333;
}

.markdown-body .pl-ent {
  color: #63a35c;
}

.markdown-body .pl-k {
  color: #a71d5d;
}

.markdown-body .pl-pds,
.markdown-body .pl-s,
.markdown-body .pl-s .pl-pse .pl-s1,
.markdown-body .pl-sr,
.markdown-body .pl-sr .pl-cce,
.markdown-body .pl-sr .pl-sra,
.markdown-body .pl-sr .pl-sre {
  color: #183691;
}

.markdown-body .pl-v {
  color: #ed6a43;
}

.markdown-body .pl-id {
  color: #b52a1d;
}

.markdown-body .pl-ii {
  background-color: #b52a1d;
  color: #f8f8f8;
}

.markdown-body .pl-sr .pl-cce {
  color: #63a35c;
  font-weight: bold;
}

.markdown-body .pl-ml {
  color: #693a17;
}

.markdown-body .pl-mh,
.markdown-body .pl-mh .pl-en,
.markdown-body .pl-ms {
  color: #1d3e81;
  font-weight: bold;
}

.markdown-body .pl-mq {
  color: #008080;
}

.markdown-body .pl-mi {
  color: #333;
  font-style: italic;
}

.markdown-body .pl-mb {
  color: #333;
  font-weight: bold;
}

.markdown-body .pl-md {
  background-color: #ffecec;
  color: #bd2c00;
}

.markdown-body .pl-mi1 {
  background-color: #eaffea;
  color: #55a532;
}

.markdown-body .pl-mdr {
  color: #795da3;
  font-weight: bold;
}

.markdown-body .pl-mo {
  color: #1d3e81;
}

.markdown-body kbd {
  display: inline-block;
  padding: 3px 5px;
  font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
  line-height: 10px;
  color: #555;
  vertical-align: middle;
  background-color: #fcfcfc;
  border: solid 1px #ccc;
  border-bottom-color: #bbb;
  border-radius: 3px;
  box-shadow: inset 0 -1px 0 #bbb;
}

.markdown-body .plan-price-unit {
  color: #767676;
  font-weight: normal;
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  margin: 0 0.35em 0.25em -1.6em;
  vertical-align: middle;
}

.markdown-body .plan-choice {
  padding: 15px;
  padding-left: 40px;
  display: block;
  border: 1px solid #e0e0e0;
  position: relative;
  font-weight: normal;
  background-color: #fafafa;
}

.markdown-body .plan-choice.open {
  background-color: #fff;
}

.markdown-body .plan-choice.open .plan-choice-seat-breakdown {
  display: block;
}

.markdown-body .plan-choice-free {
  border-radius: 3px 3px 0 0;
}

.markdown-body .plan-choice-paid {
  border-radius: 0 0 3px 3px;
  border-top: 0;
  margin-bottom: 20px;
}

.markdown-body .plan-choice-radio {
  position: absolute;
  left: 15px;
  top: 18px;
}

.markdown-body .plan-choice-exp {
  color: #999;
  font-size: 12px;
  margin-top: 5px;
}

.markdown-body .plan-choice-seat-breakdown {
  margin-top: 10px;
  display: none;
}

.markdown-body :checked+.radio-label {
  z-index: 1;
  position: relative;
  border-color: #4078c0;
}

@media print {
  body .markdown-body {
    padding: 0;
    border: none;
  }
}
</style><title>PresentAsyncAPI</title></head><body><article class="markdown-body"><h1>
<a id="user-content-building-an-async-api-with-aspnet-core" class="anchor" href="file:///C:/users/brooks~1/appdata/local/temp/13.html#building-an-async-api-with-aspnet-core" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Building an Async API with ASP.NET Core</h1>
<h2>
<a id="user-content-why" class="anchor" href="file:///C:/users/brooks~1/appdata/local/temp/13.html#why" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Why</h2>
<p>To avoid a service becoming slow or unavailable under high traffic levels. Typically returning a HTTP error status of 503 to clients, indicating that a server is temporarily unable to handle the request.</p>
<p>By supporting vertical scalability on the server. To support more requests per second by adding server resources such as processing power.</p>
<h2>
<a id="user-content-how" class="anchor" href="file:///C:/users/brooks~1/appdata/local/temp/13.html#how" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How</h2>
<p>Synchronous code reduces scalability, it gets a thread from the thread pool, but doesnt release it until the request has been fully processed. A significent amount of this time may be spent waiting for a IO operation ( e.g. filesystem, database or network call) to complete. This is time the thread isnt available to the threadpool, for other requests.</p>
<p>Async code returns threads to the threadpool ASAP. This improves the vertical scalability at server level.</p>
<p>The thread is returned to the threadpool whilst the IO request is running, a thread is only required from the thread pool when the IO request has been complete.</p>
<p><em>note</em>
This session looks at IO bound work, not computational bound work. Async should not be used on the server for computational-bound work. This could reduce scalability.</p>
<h2>
<a id="user-content-code" class="anchor" href="file:///C:/users/brooks~1/appdata/local/temp/13.html#code" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Code</h2>
<h3>
<a id="user-content-terms" class="anchor" href="file:///C:/users/brooks~1/appdata/local/temp/13.html#terms" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Terms</h3>
<p>A thread is a basic unit of CPU utilization.</p>
<p>A thread thats handling an async request is freed up to handle other requests. It doesnt wait idly for an I/O operation to finish.</p>
<p>Multi threading means a single CPU or CPU core can execute multiple threads concurrently.</p>
<p>Concurrency is a condition that exists when at least two threads are making progress.</p>
<p>Parallelism means that at least two threads are excuting simulataneously. Achieved on API if webserver has a multi core processor.</p>
<h3>
<a id="user-content-data-access-layer" class="anchor" href="file:///C:/users/brooks~1/appdata/local/temp/13.html#data-access-layer" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Data access layer</h3>
<p>Start at the bottom with your data access layer</p>
<h4>
<a id="user-content-async--await" class="anchor" href="file:///C:/users/brooks~1/appdata/local/temp/13.html#async--await" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>async &amp; await</h4>
<p>Mark a method with the async modifier.
This allows us to use the await keyword within that method.
It also allows this method to be awaited.</p>
<p>The compiler transforms the method into a state machine</p>
<p>Await is an operator. It tells the compiler that the async method cant continue until the awaited asyc process is complete. Control returns to caller, potentially all the way back up to the thread being freed.</p>
<p><a href="https://github.com/KevinDockx/BuildingAsyncAPIAspNetCore/blob/master/Finished%20sample/Books/Books.Api/Services/BooksRepository.cs">Example code</a></p>
<div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span> <span class="pl-k">async</span> <span class="pl-en">Task</span>&lt;<span class="pl-en">Book</span>&gt; <span class="pl-en">GetBookAsync</span>(<span class="pl-en">Guid</span> <span class="pl-smi">id</span>)
{
    <span class="pl-k">return</span> <span class="pl-k">await</span> <span class="pl-smi">_context</span>.<span class="pl-smi">Books</span>.<span class="pl-en">Include</span>(<span class="pl-smi">b</span> <span class="pl-k">=&gt;</span> <span class="pl-smi">b</span>.<span class="pl-smi">Author</span>)
        .<span class="pl-en">SingleOrDefaultAsync</span>(<span class="pl-smi">b</span> <span class="pl-k">=&gt;</span> <span class="pl-smi">b</span>.<span class="pl-smi">Id</span> <span class="pl-k">==</span> <span class="pl-smi">id</span>);
}</pre></div>
<h4>
<a id="user-content-task-and-task" class="anchor" href="file:///C:/users/brooks~1/appdata/local/temp/13.html#task-and-task" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Task and Task</h4>
<p>How do we know when a awaited method has completed ?
By use of the Task or Task type returned by the async method.
( or type with an accessible GetAwaiter method, or which implements ICriticalNotifyCompletion )</p>
<p>Tasks have properties such as Status, IsCancelled, IsCompleted, IsFaulted.</p>
<h3>
<a id="user-content-controllers" class="anchor" href="file:///C:/users/brooks~1/appdata/local/temp/13.html#controllers" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Controllers</h3>
<p>Having started added async to bottom layer of code, data access, this section shows adding async support at the top level, the controller.</p>
<div class="highlight highlight-source-cs"><pre>[<span class="pl-en">HttpGet</span>]
[<span class="pl-en">BooksResultFilter</span>]
<span class="pl-k">public</span> <span class="pl-k">async</span> <span class="pl-en">Task</span>&lt;<span class="pl-en">IActionResult</span>&gt; <span class="pl-en">GetBooks</span>()
{
    <span class="pl-k">var</span> <span class="pl-smi">bookEntities</span> <span class="pl-k">=</span> <span class="pl-k">await</span> <span class="pl-smi">_booksRepository</span>.<span class="pl-en">GetBooksAsync</span>();
    <span class="pl-k">return</span> <span class="pl-en">Ok</span>(<span class="pl-smi">bookEntities</span>);
}</pre></div>
<p>(BooksResultFilter is where this course implments mapping from entities to models)</p>
<p><a href="https://github.com/KevinDockx/BuildingAsyncAPIAspNetCore/blob/master/Finished%20sample/Books/Books.Api/Controllers/BooksController.cs">ExampleCode</a></p>
<h2>
<a id="user-content-measuring-with-load-testing" class="anchor" href="file:///C:/users/brooks~1/appdata/local/temp/13.html#measuring-with-load-testing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Measuring with load testing</h2>
<p>If you want to do your own load testing, e.g. to measure the improvements of using async then the tool referenced in this course is the free, West Wind WebSurge.</p>
<p>You can define requests, the amount of time to fire requests for, the number of threads to use to send requests for that amount of time. It shows you statistics at end of run.</p>
<p><a href="https://app.pluralsight.com/course-player?clipId=83cb7ef8-3614-4434-a3d9-56958d4ba1b7" rel="nofollow">VideoDemo</a></p>
<p>The course work uses some temporary code to throttle threads to help see benefits of async code versus sync code in local load tests :</p>
<div class="highlight highlight-source-cs"><pre><span class="pl-c"><span class="pl-c">//</span> throttle the thread pool (set available threads to amount of processors)</span>
<span class="pl-c"><span class="pl-c">//</span> for purposes of local load testing only, dont check in !!</span>
<span class="pl-c"><span class="pl-c">//</span> https://github.com/KevinDockx/BuildingAsyncAPIAspNetCore/blob/master/Finished%20sample/Books/Books.Api/Program.cs</span>
<span class="pl-smi">ThreadPool</span>.<span class="pl-en">SetMaxThreads</span>(<span class="pl-smi">Environment</span>.<span class="pl-smi">ProcessorCount</span>, 
    <span class="pl-smi">Environment</span>.<span class="pl-smi">ProcessorCount</span>);</pre></div>
<p><a href="https://github.com/KevinDockx/BuildingAsyncAPIAspNetCore/blob/master/Finished%20sample/Books/Books.Api/Program.cs">Thread throttling code in situ</a></p>
<p>It also adds an artificial delay for same reason, to simulate a slow IO task :</p>
<div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span> <span class="pl-k">async</span> <span class="pl-en">Task</span>&lt;<span class="pl-en">IEnumerable</span>&lt;<span class="pl-en">Book</span>&gt;&gt; <span class="pl-en">GetBooksAsync</span>()
{
    <span class="pl-c"><span class="pl-c">//</span> Dont check this artifical delay in !</span>
    <span class="pl-k">await</span> <span class="pl-smi">_context</span>.<span class="pl-smi">Database</span>.<span class="pl-en">ExecuteSqlCommandAsync</span>(<span class="pl-s"><span class="pl-pds">"</span>WAITFOR DELAY '00:00:02';<span class="pl-pds">"</span></span>);
    <span class="pl-k">return</span> <span class="pl-k">await</span> <span class="pl-smi">_context</span>.<span class="pl-smi">Books</span>.<span class="pl-en">Include</span>(<span class="pl-smi">b</span> <span class="pl-k">=&gt;</span> <span class="pl-smi">b</span>.<span class="pl-smi">Author</span>).<span class="pl-en">ToListAsync</span>();
}</pre></div>
<p><a href="https://github.com/KevinDockx/BuildingAsyncAPIAspNetCore/blob/master/Finished%20sample/Books/Books.Api/Services/BooksRepository.cs">Slow IO simulation code in situ</a></p>
<h3>
<a id="user-content-asynchronously-manipulating-resources" class="anchor" href="file:///C:/users/brooks~1/appdata/local/temp/13.html#asynchronously-manipulating-resources" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Asynchronously Manipulating Resources</h3>
<p>This section of course looks at improving scalability by supporting inserting multiple resources using a single request.</p>
<h4>
<a id="user-content-waiting-for-multiple-tasks-to-complete" class="anchor" href="file:///C:/users/brooks~1/appdata/local/temp/13.html#waiting-for-multiple-tasks-to-complete" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Waiting for multiple tasks to complete</h4>
<p>Use Task.WhenAll() or Task.WhenAny() when executing multiple tasks in parallel.</p>
<h4>
<a id="user-content-cancelling-tasks" class="anchor" href="file:///C:/users/brooks~1/appdata/local/temp/13.html#cancelling-tasks" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Cancelling Tasks</h4>
<p>Cancelling tasks frees up threads, improving scalability.</p>
<p>If one task fails you may want to cancel any related tasks.</p>
<p>See CancellationTokenSource and CancellationToken types.</p>
<p><a href="https://github.com/KevinDockx/BuildingAsyncAPIAspNetCore/blob/master/Finished%20sample/Books/Books.Api/Services/BooksRepository.cs">Example Code</a></p>
<div class="highlight highlight-source-cs"><pre> <span class="pl-k">private</span> <span class="pl-en">CancellationTokenSource</span> <span class="pl-smi">_cancellationTokenSource</span>;</pre></div>
<p>Pass the _cancellationTokenSource.Token into to your async methods :</p>
<div class="highlight highlight-source-cs"><pre><span class="pl-k">var</span> <span class="pl-smi">downloadBookCoverTasksQuery</span> <span class="pl-k">=</span>
     <span class="pl-smi">from</span> <span class="pl-smi">bookCoverUrl</span>
     <span class="pl-smi">in</span> <span class="pl-smi">bookCoverUrls</span>
     <span class="pl-smi">select</span> <span class="pl-en">DownloadBookCoverAsync</span>(<span class="pl-smi">httpClient</span>, <span class="pl-smi">bookCoverUrl</span>, <span class="pl-smi">_cancellationTokenSource</span>.<span class="pl-smi">Token</span>);</pre></div>
<p>If a task fails, trigger the cancellation :</p>
<div class="highlight highlight-source-cs"><pre><span class="pl-k">var</span> <span class="pl-smi">response</span> <span class="pl-k">=</span> <span class="pl-k">await</span> <span class="pl-smi">httpClient</span>.<span class="pl-en">GetAsync</span>(<span class="pl-smi">bookCoverUrl</span>, <span class="pl-smi">cancellationToken</span>);

<span class="pl-k">if</span> (<span class="pl-smi">response</span>.<span class="pl-smi">IsSuccessStatusCode</span>)
{
    <span class="pl-k">var</span> <span class="pl-smi">bookCover</span> <span class="pl-k">=</span> <span class="pl-smi">JsonConvert</span>.<span class="pl-en">DeserializeObject</span>&lt;<span class="pl-en">BookCover</span>&gt;(
        <span class="pl-k">await</span> <span class="pl-smi">response</span>.<span class="pl-smi">Content</span>.<span class="pl-en">ReadAsStringAsync</span>());
    <span class="pl-k">return</span> <span class="pl-smi">bookCover</span>;
}

<span class="pl-smi">_cancellationTokenSource</span>.<span class="pl-en">Cancel</span>();</pre></div>
<p>Cleanup cancellation token sources ( as with datacontexts ) as required</p>
<div class="highlight highlight-source-cs"><pre><span class="pl-k">protected</span> <span class="pl-k">virtual</span> <span class="pl-k">void</span> <span class="pl-en">Dispose</span>(<span class="pl-k">bool</span> <span class="pl-smi">disposing</span>)
{
    <span class="pl-k">if</span> (<span class="pl-smi">disposing</span>)
    {
        <span class="pl-k">if</span> (<span class="pl-smi">_context</span> <span class="pl-k">!=</span> <span class="pl-c1">null</span>)
        {
            <span class="pl-smi">_context</span>.<span class="pl-en">Dispose</span>();
            <span class="pl-smi">_context</span> <span class="pl-k">=</span> <span class="pl-c1">null</span>;
        }
        <span class="pl-k">if</span> (<span class="pl-smi">_cancellationTokenSource</span> <span class="pl-k">!=</span> <span class="pl-c1">null</span>)
        {
            <span class="pl-smi">_cancellationTokenSource</span>.<span class="pl-en">Dispose</span>();
            <span class="pl-smi">_cancellationTokenSource</span> <span class="pl-k">=</span> <span class="pl-c1">null</span>;
        }
    }
}</pre></div>
<h4>
<a id="user-content-handling-exceptions" class="anchor" href="file:///C:/users/brooks~1/appdata/local/temp/13.html#handling-exceptions" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Handling exceptions</h4>
<p>Catch OperationCancelledException which exposes the CancellationToken.</p>
<h2>
<a id="user-content-avoiding-common-pitfalls" class="anchor" href="file:///C:/users/brooks~1/appdata/local/temp/13.html#avoiding-common-pitfalls" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Avoiding Common Pitfalls</h2>
<p><a href="https://app.pluralsight.com/course-player?clipId=11580530-8b04-44f4-ba2d-887a7034050c" rel="nofollow">Clip</a></p>
<p>e.g.</p>
<ul>
<li>Dont wrap synchronous, computational bound, code with async methods. Await is optimised for I/O bound work, not computational bound.</li>
<li>Dont block async code, e.g. by returning Task.Result from a method, or calling .Wait() on task.</li>
<li>Dont modify shared state, its not threadsafe and can cause difficult to detect bugs.</li>
</ul>
<h2>
<a id="user-content-further-information" class="anchor" href="file:///C:/users/brooks~1/appdata/local/temp/13.html#further-information" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Further information</h2>
<p>Building an Async API with ASP.NET Core pluralsight course by Kevin Dockx
<a href="https://app.pluralsight.com/library/courses/building-async-api-aspdotnet-core/" rel="nofollow">Course</a>
<a href="https://github.com/KevinDockx/BuildingAsyncAPIAspNetCore">CourseCode</a></p>
</article></body></html>